{% extends "base.html" %}

{% block title %}–†–µ–¥–∞–∫—Ç–æ—Ä —Å—é–∂–µ—Ç–∞: {{ story.title }} ‚Äî –ê–¥–º–∏–Ω–∫–∞{% endblock %}

{% block extra_css %}
<style>
  :root {
    --bg-primary: #0a0a0f;
    --bg-gradient-start: #0f0f1a;
    --bg-gradient-end: #1a1a2e;
    --accent: #6366f1;
    --accent-dark: #4f46e5;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --card-bg: rgba(20, 20, 40, 0.7);
    --card-border: rgba(99, 102, 241, 0.3);
    --input-bg: rgba(30, 30, 50, 0.6);
    --input-border: rgba(99, 102, 241, 0.3);
    --editor-bg: rgba(15, 15, 30, 0.8);
  }

  [data-theme="orange"] {
    --bg-primary: #080503;
    --bg-gradient-start: #0d0704;
    --bg-gradient-end: #1a1208;
    --accent: #f97316;
    --accent-dark: #ea580c;
    --text-primary: #fef3c7;
    --text-secondary: #fcd34d;
    --card-bg: rgba(40, 20, 10, 0.7);
    --card-border: rgba(249, 115, 22, 0.3);
    --input-bg: rgba(50, 30, 15, 0.6);
    --input-border: rgba(249, 115, 22, 0.3);
    --editor-bg: rgba(25, 15, 5, 0.8);
  }

  [data-theme="purple"] {
    --bg-primary: #0a0515;
    --bg-gradient-start: #0d061a;
    --bg-gradient-end: #1a082e;
    --accent: #8b5cf6;
    --accent-dark: #7c3aed;
    --text-primary: #e0e7ff;
    --text-secondary: #cbd5e1;
    --card-bg: rgba(30, 15, 40, 0.7);
    --card-border: rgba(139, 92, 246, 0.3);
    --input-bg: rgba(40, 25, 50, 0.6);
    --input-border: rgba(139, 92, 246, 0.3);
    --editor-bg: rgba(20, 10, 30, 0.8);
  }

  [data-theme="dark-green"] {
    --bg-primary: #050a06;
    --bg-gradient-start: #070f0a;
    --bg-gradient-end: #122014;
    --accent: #10b981;
    --accent-dark: #059669;
    --text-primary: #d1fae5;
    --text-secondary: #6ee7b7;
    --card-bg: rgba(10, 40, 25, 0.7);
    --card-border: rgba(16, 185, 129, 0.3);
    --input-bg: rgba(15, 50, 35, 0.6);
    --input-border: rgba(16, 185, 129, 0.3);
    --editor-bg: rgba(5, 35, 20, 0.8);
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    min-height: 100vh;
    overflow-x: hidden;
  }

  .editor-container {
    display: flex;
    min-height: calc(100vh - 60px);
  }

  .sidebar {
    width: 280px;
    background: var(--editor-bg);
    border-right: 1px solid var(--card-border);
    overflow-y: auto;
    padding: 20px 0;
    flex-shrink: 0;
  }

  .sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid var(--card-border);
    margin-bottom: 20px;
  }

  .sidebar-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .sidebar-title svg {
    width: 24px;
    height: 24px;
    fill: var(--accent);
  }

  .chapters-list {
    padding: 0 20px;
  }

  .chapter-item {
    background: rgba(99, 102, 241, 0.05);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .chapter-item:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--accent);
  }

  .chapter-item.active {
    background: rgba(99, 102, 241, 0.15);
    border-color: var(--accent);
    position: relative;
  }

  .chapter-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--accent);
    border-radius: 4px 0 0 4px;
  }

  .chapter-number {
    font-weight: 700;
    font-size: 16px;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .chapter-title {
    font-size: 14px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .chapter-scenes {
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px;
    opacity: 0.8;
  }

  .sidebar-actions {
    padding: 20px;
    border-top: 1px solid var(--card-border);
    margin-top: 20px;
  }

  .btn-add-chapter {
    width: 100%;
    padding: 12px;
    background: rgba(16, 185, 129, 0.1);
    border: 2px dashed rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    color: #10b981;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-add-chapter:hover {
    background: rgba(16, 185, 129, 0.15);
    border-style: solid;
  }

  .main-editor {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .editor-header {
    height: 60px;
    background: rgba(15, 15, 35, 0.9);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--card-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .editor-title {
    font-size: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .editor-title span {
    color: var(--text-secondary);
    font-weight: 400;
  }

  .editor-actions {
    display: flex;
    gap: 12px;
  }

  .btn-editor {
    padding: 8px 16px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-save {
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    color: white;
    border: none;
  }

  .btn-save:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
  }

  .btn-preview {
    background: rgba(99, 102, 241, 0.1);
    color: var(--accent);
    border: 2px solid var(--input-border);
  }

  .btn-preview:hover {
    background: rgba(99, 102, 241, 0.15);
  }

  .btn-export {
    background: rgba(255, 158, 0, 0.1);
    color: #ff9e00;
    border: 2px solid rgba(255, 158, 0, 0.3);
  }

  .btn-export:hover {
    background: rgba(255, 158, 0, 0.15);
  }

  .editor-content {
    flex: 1;
    display: flex;
    overflow: hidden;
    padding: 24px;
  }

  .scene-list {
    width: 300px;
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    overflow-y: auto;
    flex-shrink: 0;
    margin-right: 24px;
    display: flex;
    flex-direction: column;
  }

  .scene-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--card-border);
  }

  .scene-list-title {
    font-size: 18px;
    font-weight: 700;
    color: var(--accent);
  }

  .btn-add-scene {
    background: rgba(16, 185, 129, 0.1);
    border: 2px dashed rgba(16, 185, 129, 0.3);
    border-radius: 10px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-add-scene:hover {
    background: rgba(16, 185, 129, 0.15);
    border-style: solid;
  }

  .scenes-container {
    flex: 1;
  }

  .scene-item {
    background: rgba(99, 102, 241, 0.05);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .scene-item:hover {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--accent);
  }

  .scene-item.active {
    background: rgba(99, 102, 241, 0.15);
    border-color: var(--accent);
    position: relative;
  }

  .scene-item.active::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: var(--accent);
    border-radius: 3px 0 0 3px;
  }

  .scene-number {
    font-weight: 700;
    font-size: 16px;
    color: var(--accent);
    margin-bottom: 6px;
  }

  .scene-character {
    font-size: 14px;
    margin-bottom: 4px;
  }

  .scene-dialogue {
    font-size: 13px;
    color: var(--text-secondary);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .scene-choices {
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-secondary);
    opacity: 0.8;
  }

  .scene-editor {
    flex: 1;
    background: var(--card-bg);
    border-radius: 16px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .scene-editor-header {
    padding: 20px;
    border-bottom: 1px solid var(--card-border);
    background: rgba(30, 30, 50, 0.3);
  }

  .scene-editor-title {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 4px;
  }

  .scene-editor-subtitle {
    color: var(--text-secondary);
    font-size: 14px;
  }

  .scene-editor-content {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  .editor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  .editor-section {
    margin-bottom: 24px;
  }

  .editor-section-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 16px;
    color: var(--accent);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
    color: var(--text-primary);
  }

  .form-control {
    width: 100%;
    padding: 12px 16px;
    background: var(--input-bg);
    border: 2px solid var(--input-border);
    border-radius: 12px;
    color: var(--text-primary);
    font-size: 15px;
    font-family: 'Inter', sans-serif;
    transition: all 0.2s;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }

  textarea.form-control {
    min-height: 120px;
    resize: vertical;
  }

  .choices-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .choice-item {
    background: rgba(99, 102, 241, 0.05);
    border: 1px solid var(--card-border);
    border-radius: 12px;
    padding: 16px;
    position: relative;
  }

  .choice-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 12px;
  }

  .choice-number {
    font-weight: 700;
    color: var(--accent);
    font-size: 16px;
  }

  .choice-actions {
    display: flex;
    gap: 8px;
  }

  .choice-btn {
    width: 32px;
    height: 32px;
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid var(--card-border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }

  .choice-btn:hover {
    background: rgba(99, 102, 241, 0.2);
    transform: scale(1.1);
  }

  .choice-btn.delete {
    background: rgba(239, 68, 68, 0.1);
    border-color: rgba(239, 68, 68, 0.3);
  }

  .choice-btn.delete:hover {
    background: rgba(239, 68, 68, 0.2);
  }

  .choice-text {
    font-weight: 500;
    margin-bottom: 12px;
  }

  .choice-effects {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    font-size: 13px;
  }

  .choice-effect {
    display: flex;
    flex-direction: column;
  }

  .choice-effect-label {
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-size: 12px;
  }

  .choice-effect-value {
    font-weight: 600;
    color: var(--accent);
  }

  .btn-add-choice {
    width: 100%;
    padding: 14px;
    background: rgba(16, 185, 129, 0.1);
    border: 2px dashed rgba(16, 185, 129, 0.3);
    border-radius: 12px;
    color: #10b981;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-add-choice:hover {
    background: rgba(16, 185, 129, 0.15);
    border-style: solid;
  }

  .premium-toggle {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 26px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--input-border);
    transition: .4s;
    border-radius: 34px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: #ff9e00;
  }

  input:checked + .slider:before {
    transform: translateX(22px);
  }

  .empty-scene {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-secondary);
    text-align: center;
    padding: 40px;
  }

  .empty-icon {
    font-size: 48px;
    margin-bottom: 20px;
    opacity: 0.3;
  }

  .empty-text {
    font-size: 18px;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .empty-subtext {
    color: var(--text-secondary);
    opacity: 0.8;
    max-width: 300px;
  }

  .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(5px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .modal.active {
    opacity: 1;
    pointer-events: all;
  }

  .modal-content {
    background: var(--card-bg);
    border: 2px solid var(--card-border);
    border-radius: 24px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 32px;
    transform: translateY(20px);
    transition: transform 0.3s ease;
  }

  .modal.active .modal-content {
    transform: translateY(0);
  }

  .modal-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 24px;
    text-align: center;
    color: var(--accent);
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--card-border);
  }

  .btn-modal {
    padding: 12px 28px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-modal-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    color: white;
    border: none;
  }

  .btn-modal-secondary {
    background: rgba(99, 102, 241, 0.1);
    color: var(--accent);
    border: 2px solid var(--input-border);
  }

  .btn-upload {
    background: rgba(99, 102, 241, 0.1);
    color: var(--accent);
    border: 2px solid var(--input-border);
    padding: 12px 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
  }

  .btn-upload:hover {
    background: rgba(99, 102, 241, 0.15);
  }

  @media (max-width: 1100px) {
    .editor-grid {
      grid-template-columns: 1fr;
    }

    .scene-list {
      width: 260px;
    }
  }

  @media (max-width: 900px) {
    .sidebar {
      width: 240px;
    }

    .scene-list {
      width: 240px;
      margin-right: 16px;
    }

    .editor-content {
      padding: 16px;
    }
  }

  @media (max-width: 768px) {
    .editor-container {
      flex-direction: column;
    }

    .sidebar {
      width: 100%;
      height: auto;
      max-height: 300px;
    }

    .scene-list {
      width: 100%;
      margin-right: 0;
      margin-top: 16px;
      max-height: 300px;
    }

    .editor-header {
      padding: 0 16px;
      height: 56px;
    }

    .editor-title {
      font-size: 18px;
    }

    .scene-editor-content {
      padding: 16px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
  <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –≥–ª–∞–≤–∞–º–∏ -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">
        <svg viewBox="0 0 24 24">
          <path fill="currentColor" d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A2,2 0 0,0 10,9A2,2 0 0,0 12,11A2,2 0 0,0 14,9A2,2 0 0,0 12,7M4,18H20V16H4V18M4,14H20V12H4V14M4,10H10V8H4V10Z" />
        </svg>
        <span>{{ story.title }}</span>
      </div>
    </div>

    <div class="chapters-list" id="chaptersList">
      <!-- –ì–ª–∞–≤—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>

    <div class="sidebar-actions">
      <button class="btn-add-chapter" id="addChapterBtn">
        <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
          <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
        </svg>
        –î–æ–±–∞–≤–∏—Ç—å –≥–ª–∞–≤—É
      </button>
    </div>
  </div>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä -->
  <div class="main-editor">
    <div class="editor-header">
      <div class="editor-title">
        –ì–ª–∞–≤–∞ <span id="currentChapterNumber">1</span> ‚Äî
        <span id="currentChapterTitle">–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è</span>
      </div>

      <div class="editor-actions">
        <button class="btn-editor btn-preview" onclick="previewStory()">
          <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4A10,10 0 0,0 2,14C2,16.67 3.11,19.11 5,21C5.5,21.5 6,22 7,22H17C18,22 18.5,21.5 19,21C20.89,19.11 22,16.67 22,14A10,10 0 0,0 12,4Z" />
          </svg>
          –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        </button>
        <button class="btn-editor btn-export" onclick="exportStory()">
          <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" />
          </svg>
          –≠–∫—Å–ø–æ—Ä—Ç
        </button>
        <button class="btn-editor btn-save" id="saveBtn">
          <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />
          </svg>
          –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
        </button>
      </div>
    </div>

    <div class="editor-content">
      <!-- –°–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω -->
      <div class="scene-list">
        <div class="scene-list-header">
          <div class="scene-list-title">–°—Ü–µ–Ω—ã</div>
          <button class="btn-add-scene" id="addSceneBtn">
            <svg style="width:20px;height:20px;" viewBox="0 0 24 24">
              <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
            </svg>
          </button>
        </div>

        <div class="scenes-container" id="scenesList">
          <div class="empty-scene">
            <div class="empty-icon">üé≠</div>
            <div class="empty-text">–ù–µ—Ç —Å—Ü–µ–Ω</div>
            <div class="empty-subtext">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Å—Ü–µ–Ω—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
          </div>
        </div>
      </div>

      <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã -->
      <div class="scene-editor">
        <div class="scene-editor-header">
          <div class="scene-editor-title" id="sceneEditorTitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É</div>
          <div class="scene-editor-subtitle" id="sceneEditorSubtitle">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ü–µ–Ω—É –≤ —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
        </div>

        <div class="scene-editor-content" id="sceneEditorContent">
          <div class="empty-scene">
            <div class="empty-icon">‚ú®</div>
            <div class="empty-text">–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã</div>
            <div class="empty-subtext">–°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥–ª–∞–≤—ã -->
<div class="modal" id="chapterModal">
  <div class="modal-content">
    <h3 class="modal-title" id="chapterModalTitle">–ù–æ–≤–∞—è –≥–ª–∞–≤–∞</h3>
    <form id="chapterForm">
      <input type="hidden" id="chapterId" value="">

      <div class="form-group">
        <label for="chapterNumber">–ù–æ–º–µ—Ä –≥–ª–∞–≤—ã *</label>
        <input type="number" id="chapterNumber" class="form-control" min="1" required>
      </div>

      <div class="form-group">
        <label for="chapterTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã</label>
        <input type="text" id="chapterTitle" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–≤–∞—è –≤—Å—Ç—Ä–µ—á–∞">
      </div>

      <div class="form-group">
        <label for="chapterDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="chapterDescription" class="form-control" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≥–ª–∞–≤—ã..."></textarea>
      </div>

      <div class="form-group">
        <label for="chapterBackground">–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="chapterBackground" class="form-control" placeholder="background1.jpg">
          <button type="button" class="btn-upload" onclick="uploadImage('chapterBackground')">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
              <path fill="currentColor" d="M5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21M15,13H9V11H15M15,17H9V15H15M15,9H9V7H15M15,5H9V3H15M15,19H9V17H15" />
            </svg>
            –ó–∞–≥—Ä—É–∑–∏—Ç—å
          </button>
        </div>
        <small class="form-hint">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥–ª–∞–≤—ã (–ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ñ–æ–Ω –∏—Å—Ç–æ—Ä–∏–∏)</small>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('chapterModal')">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-modal btn-modal-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–∞–≤—É</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ü–µ–Ω—ã -->
<div class="modal" id="sceneModal">
  <div class="modal-content">
    <h3 class="modal-title" id="sceneModalTitle">–ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞</h3>
    <form id="sceneForm">
      <input type="hidden" id="sceneId" value="">
      <input type="hidden" id="sceneChapterId" value="{{ story.id }}">

      <div class="form-group">
        <label for="sceneNumber">–ù–æ–º–µ—Ä —Å—Ü–µ–Ω—ã *</label>
        <input type="number" id="sceneNumber" class="form-control" min="1" required>
      </div>

      <div class="form-group">
        <label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ *</label>
        <input type="text" id="characterName" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–∏–∫—Å–∞—Ä–∏—è" required>
      </div>

      <div class="form-group">
        <label for="dialogueText">–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞ *</label>
        <textarea id="dialogueText" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞..." required></textarea>
      </div>

      <div class="editor-grid">
        <div class="editor-section">
          <div class="editor-section-title">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
              <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
            </svg>
            –ü–µ—Ä—Å–æ–Ω–∞–∂
          </div>

          <div class="form-group">
            <label for="characterImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="characterImage" class="form-control" placeholder="guy.png">
              <button type="button" class="btn-upload" onclick="uploadImage('characterImage')">
                <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21M15,13H9V11H15M15,17H9V15H15M15,9H9V7H15M15,5H9V3H15M15,19H9V17H15" />
                </svg>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
            </div>
          </div>

          <div class="form-group">
            <label for="positionX">–ü–æ–∑–∏—Ü–∏—è X</label>
            <input type="number" id="positionX" class="form-control" value="0">
          </div>

          <div class="form-group">
            <label for="positionY">–ü–æ–∑–∏—Ü–∏—è Y</label>
            <input type="number" id="positionY" class="form-control" value="0">
          </div>

          <div class="form-group">
            <label for="scale">–ú–∞—Å—à—Ç–∞–±</label>
            <input type="number" id="scale" class="form-control" step="0.1" value="1.0">
          </div>
        </div>

        <div class="editor-section">
          <div class="editor-section-title">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
              <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
            </svg>
            –§–æ–Ω –∏ –∑–≤—É–∫
          </div>

          <div class="form-group">
            <label for="sceneBackground">–§–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="sceneBackground" class="form-control" placeholder="background1.jpg">
              <button type="button" class="btn-upload" onclick="uploadImage('sceneBackground')">
                <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21M15,13H9V11H15M15,17H9V15H15M15,9H9V7H15M15,5H9V3H15M15,19H9V17H15" />
                </svg>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
            </div>
            <small class="form-hint">–ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç —Ñ–æ–Ω –≥–ª–∞–≤—ã/–∏—Å—Ç–æ—Ä–∏–∏</small>
          </div>

          <div class="form-group">
            <label for="musicTrack">–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π —Ç—Ä–µ–∫</label>
            <input type="text" id="musicTrack" class="form-control" placeholder="romantic_theme.mp3">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('sceneModal')">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-modal btn-modal-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω—É</button>
      </div>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ -->
<div class="modal" id="choiceModal">
  <div class="modal-content">
    <h3 class="modal-title" id="choiceModalTitle">–ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞</h3>
    <form id="choiceForm">
      <input type="hidden" id="choiceId" value="">
      <input type="hidden" id="choiceSceneId" value="">

      <div class="form-group">
        <label for="choiceNumber">–ù–æ–º–µ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ *</label>
        <input type="number" id="choiceNumber" class="form-control" min="1" required>
      </div>

      <div class="form-group">
        <label for="choiceText">–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞ *</label>
        <textarea id="choiceText" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: (–ù–∞–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ —Ä—É–∫—É.)" required></textarea>
      </div>

      <div class="editor-section">
        <div class="editor-section-title">
          <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg>
          –ü–µ—Ä–µ—Ö–æ–¥
        </div>

        <div class="form-group">
          <label for="nextSceneId">–°–ª–µ–¥—É—é—â–∞—è —Å—Ü–µ–Ω–∞ ID</label>
          <input type="number" id="nextSceneId" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="nextChapterId">–°–ª–µ–¥—É—é—â–∞—è –≥–ª–∞–≤–∞ ID</label>
          <input type="number" id="nextChapterId" class="form-control" required>
        </div>
      </div>

      <div class="editor-section">
        <div class="editor-section-title">
          <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg>
          –≠—Ñ—Ñ–µ–∫—Ç—ã
        </div>

        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label for="friendshipChange">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥—Ä—É–∂–µ–ª—é–±–∏—è</label>
            <input type="number" id="friendshipChange" class="form-control" value="0">
          </div>

          <div class="form-group" style="flex:1;">
            <label for="teasingChange">–î—Ä–∞–∑–Ω–µ–Ω–∏—è/teasing/–°–∞–º –ø–µ—Ä–µ–≤–µ–¥–∏ –µ–π –±–æ–≥—É</label>
            <input type="number" id="teasingChange" class="form-control" value="0">
          </div>

          <div class="form-group" style="flex:1;">
            <label for="passionChange">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Å—Ç–∏</label>
            <input type="number" id="passionChange" class="form-control" value="0">
          </div>

          <div class="editor-section-title">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
              <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
            </svg>
            –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
          </div>

          <div class="form-group" style="flex:1;">
            <label for="requiredPassionLevel">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —É—Ä–æ–≤–µ–Ω—å —Å—Ç—Ä–∞—Å—Ç–∏</label>
            <input type="number" id="requiredPassionLevel" class="form-control" value="0">
          </div>

          <div class="form-group" style="flex:1;">
            <label for="requiredTeasingLevel">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —É—Ä–æ–≤–µ–Ω—å teasing</label>
            <input type="number" id="requiredTeasingLevel" class="form-control" value="0">
          </div>

          <div class="form-group" style="flex:1;">
            <label for="requiredFriendshipLevel">–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–π —É—Ä–æ–≤–µ–Ω—å –¥—Ä—É–∂–±—ã</label>
            <input type="number" id="requiredFriendshipLevel" class="form-control" value="0">
          </div>

          <div class="editor-section-title">
            <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
              <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
            </svg>
            –ö–æ–Ω—Ü–æ–≤–∫–∏ (–µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ)
          </div>

          <div class="form-group" style="flex:1;">
            <label for="legendChoice">–í–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ë—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–æ–Ω—Ü–æ–≤–∫–µ)</label>
            <input type="checkbox" id="legendChoice" class="form-control" value="false">
          </div>
          <div class="form-group" style="flex:1;">
            <label for="legendTitle">–¢–µ–∫—Å—Ç –¥–ª—è –∫–æ–Ω—Ü–æ–≤–∫–∏ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø—Ä–æ—à–ª—ã–π –ø—É–Ω–∫—Ç)</label>
            <textarea  id="legendTitle" class="form-control"></textarea>
          </div>
          <div class="form-group">
            <label for="chapterBackground">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ü–æ–≤–∫–∏</label>
            <div style="display: flex; gap: 8px;">
              <input type="text" id="legendBackground" class="form-control" placeholder="background1.jpg">
              <button type="button" class="btn-upload" onclick="uploadImage('legendBackground')">
                <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21M15,13H9V11H15M15,17H9V15H15M15,9H9V7H15M15,5H9V3H15M15,19H9V17H15" />
                </svg>
                –ó–∞–≥—Ä—É–∑–∏—Ç—å
              </button>
            </div>
            <small class="form-hint">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω—Ü–æ–≤–∫–∏ (–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø—É–Ω–∫—Ç '–≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏')</small>
        </div>
      </div>

      <div class="editor-section">
        <div class="editor-section-title">
          <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
          </svg>
          –ü—Ä–µ–º–∏—É–º
        </div>

        <div class="premium-toggle">
          <label class="switch">
            <input type="checkbox" id="choicePremium">
            <span class="slider"></span>
          </label>
          <span>–ü—Ä–µ–º–∏—É–º –≤–∞—Ä–∏–∞–Ω—Ç (—Ç—Ä–µ–±—É–µ—Ç –∞–ª–º–∞–∑–æ–≤)</span>
        </div>

        <div class="form-group">
          <label for="diamondsCost">–°—Ç–æ–∏–º–æ—Å—Ç—å –≤ –∞–ª–º–∞–∑–∞—Ö</label>
          <input type="number" id="diamondsCost" class="form-control" value="0" min="0" step="10">
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-modal btn-modal-secondary" onclick="closeModal('choiceModal')">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-modal btn-modal-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç</button>
      </div>
    </form>
  </div>
</div>
</div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let currentStoryId = {{ story.id }};
let currentChapterId = null;
let currentSceneId = null;
let chapters = [];
let scenes = [];

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
  loadChapters();

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
  document.getElementById('addChapterBtn').addEventListener('click', () => openChapterModal());
  document.getElementById('addSceneBtn').addEventListener('click', () => openSceneModal());
  document.getElementById('saveBtn').addEventListener('click', saveStory);

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–æ—Ä–º
  document.getElementById('chapterForm').addEventListener('submit', saveChapter);
  document.getElementById('sceneForm').addEventListener('submit', saveScene);
  document.getElementById('choiceForm').addEventListener('submit', saveChoice);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –≥–ª–∞–≤
async function loadChapters() {
  try {
    const response = await fetch(`/api/stories/${currentStoryId}/chapters`);
    const data = await response.json();

    if (data.success) {
      chapters = data.chapters;
      renderChapters();

      if (chapters.length > 0) {
        selectChapter(chapters[0].id);
      }
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–ª–∞–≤');
  }
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤
function renderChapters() {
  const container = document.getElementById('chaptersList');
  container.innerHTML = '';

  if (chapters.length === 0) {
    container.innerHTML = `
      <div class="empty-scene" style="padding:20px;">
        <div class="empty-text">–ù–µ—Ç –≥–ª–∞–≤</div>
        <div class="empty-subtext">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –≥–ª–∞–≤—É –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</div>
      </div>
    `;
    return;
  }

  chapters.forEach(chapter => {
    const chapterEl = document.createElement('div');
    chapterEl.className = `chapter-item ${chapter.id === currentChapterId ? 'active' : ''}`;
    chapterEl.onclick = () => selectChapter(chapter.id);

    chapterEl.innerHTML = `
      <div class="chapter-number">–ì–ª–∞–≤–∞ ${chapter.chapter_number}</div>
      <div class="chapter-title">${chapter.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
      <p>ID: ${chapter.id}</p>
    `;

    container.appendChild(chapterEl);
  });
}

async function selectChapter(chapterId) {
  currentChapterId = chapterId;
  renderChapters();

  const chapter = chapters.find(c => c.id === chapterId);
  document.getElementById('currentChapterNumber').textContent = chapter.chapter_number;
  document.getElementById('currentChapterTitle').textContent = chapter.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

  await loadScenes(chapterId);
}

async function loadScenes(chapterId) {
  try {
    const response = await fetch(`/api/chapters/${chapterId}/scenes`);
    const data = await response.json();

    if (data.success) {
      scenes = data.scenes;
      renderScenes();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω');
  }
}

function renderScenes() {
  const container = document.getElementById('scenesList');
  container.innerHTML = '';

  if (scenes.length === 0) {
    container.innerHTML = `
      <div class="empty-scene">
        <div class="empty-icon">üé≠</div>
        <div class="empty-text">–ù–µ—Ç —Å—Ü–µ–Ω</div>
        <div class="empty-subtext">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é —Å—Ü–µ–Ω—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é</div>
      </div>
    `;
    showEmptySceneEditor();
    return;
  }

  scenes.forEach(scene => {
    const sceneEl = document.createElement('div');
    sceneEl.className = `scene-item ${scene.id === currentSceneId ? 'active' : ''}`;
    sceneEl.onclick = () => selectScene(scene.id);

    sceneEl.innerHTML = `
      <div class="scene-number">–°—Ü–µ–Ω–∞ ${scene.scene_number}</div>
      <div class="scene-character">${scene.character_name}</div>
      <div class="scene-dialogue">${scene.dialogue_text.substring(0, 60)}${scene.dialogue_text.length > 60 ? '...' : ''}</div>
      <p>ID: ${scene.id}</p>
    `;

    container.appendChild(sceneEl);
  });
}

// –í—ã–±–æ—Ä —Å—Ü–µ–Ω—ã
function selectScene(sceneId) {
  currentSceneId = sceneId;
  renderScenes();

  // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã
  const scene = scenes.find(s => s.id === sceneId);
  renderSceneEditor(scene);
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å—Ü–µ–Ω—ã
function renderSceneEditor(scene) {
  const editorContent = document.getElementById('sceneEditorContent');

  if (!scene) {
    showEmptySceneEditor();
    return;
  }

  loadChoices(scene.id).then(choices => {
    editorContent.innerHTML = `
      <div class="editor-grid">
        <div>
          <div class="editor-section">
            <div class="editor-section-title">
              <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
              </svg>
              –î–∏–∞–ª–æ–≥
            </div>

            <div class="form-group">
              <label>–ü–µ—Ä—Å–æ–Ω–∞–∂</label>
              <div style="font-size:18px;font-weight:600;color:var(--accent);">${scene.character_name}</div>
            </div>

            <div class="form-group">
              <label>–¢–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞</label>
              <div style="background:var(--input-bg);border:2px solid var(--input-border);border-radius:12px;padding:16px;font-size:16px;line-height:1.6;">
                ${scene.dialogue_text.replace(/\n/g, '<br>')}
              </div>
            </div>
          </div>

          <div class="editor-section">
            <div class="editor-section-title">
              <svg style="width:18px;height:18px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
              </svg>
              –ú–µ–¥–∏–∞
            </div>

            <div class="form-group">
              <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</label>
              <div style="font-family:monospace;background:var(--input-bg);border:2px solid var(--input-border);border-radius:12px;padding:12px;">
                ${scene.character_image || '–ù–µ –∑–∞–¥–∞–Ω–æ'}
              </div>
            </div>

            <div class="form-group">
              <label>–§–æ–Ω</label>
              <div style="font-family:monospace;background:var(--input-bg);border:2px solid var(--input-border);border-radius:12px;padding:12px;">
                ${scene.background_image || '–§–æ–Ω –≥–ª–∞–≤—ã/–∏—Å—Ç–æ—Ä–∏–∏'}
              </div>
            </div>
          </div>
        </div>

        <div>
          <div class="editor-section">
            <div class="editor-section-title" style="justify-content:space-between;display:flex;align-items:center;">
              <span>
                <svg style="width:18px;height:18px;margin-right:6px;vertical-align:middle;" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                </svg>
                –í–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ (${choices.length})
              </span>
              <button class="btn-add-choice" onclick="openChoiceModal(${scene.id})">
                <svg style="width:18px;height:18px;margin-right:6px;" viewBox="0 0 24 24">
                  <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                </svg>
                –î–æ–±–∞–≤–∏—Ç—å
              </button>
            </div>

            <div class="choices-container" id="choicesContainer">
              ${choices.length === 0 ? `
                <div style="text-align:center;color:var(--text-secondary);padding:20px;">
                  –ù–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞
                </div>
              ` : choices.map(choice => `
                <div class="choice-item">
                  <div class="choice-header">
                    <div class="choice-number">–í–∞—Ä–∏–∞–Ω—Ç ${choice.choice_number}</div>
                    <div class="choice-actions">
                      <button class="choice-btn" onclick="editChoice(${choice.id})">
                        <svg style="width:16px;height:16px;" viewBox="0 0 24 24">
                          <path fill="currentColor" d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z" />
                        </svg>
                      </button>
                      <button class="choice-btn delete" onclick="deleteChoice(${choice.id})">
                        <svg style="width:16px;height:16px;" viewBox="0 0 24 24">
                          <path fill="currentColor" d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  <div class="choice-text">${choice.choice_text}</div>
                  ${choice.premium ? `<div style="color:#ff9e00;font-weight:600;margin-top:8px;">üíé –ü—Ä–µ–º–∏—É–º –≤–∞—Ä–∏–∞–Ω—Ç</div>` : ''}
                  <div class="choice-effects">
                    <div class="choice-effect">
                      <div class="choice-effect-label">–î—Ä—É–∂–µ–ª—é–±–∏–µ</div>
                      <div class="choice-effect-value">${choice.friendship_change >= 0 ? '+' : ''}${choice.friendship_change}</div>
                    </div>
                    <div class="choice-effect">
                      <div class="choice-effect-label">Teasing</div>
                      <div class="choice-effect-value">${choice.teasing_change >= 0 ? '+' : ''}${choice.teasing_change}</div>
                    </div>
                    <div class="choice-effect">
                      <div class="choice-effect-label">–°—Ç—Ä–∞—Å—Ç—å</div>
                      <div class="choice-effect-value">${choice.passion_change >= 0 ? '+' : ''}${choice.passion_change}</div>
                    </div>
                  </div>
                  <h3>–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —É—Å–ª–æ–≤–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è</h3>
                  <div class="choice-effects">
                    <div class="choice-effect">
                      <div class="choice-effect-label">–î—Ä—É–∂–µ–ª—é–±–∏–µ</div>
                      <div class="choice-effect-value">${choice.required_friendship_level}</div>
                    </div>
                    <div class="choice-effect">
                      <div class="choice-effect-label">Teasing</div>
                      <div class="choice-effect-value">${choice.required_teasing_level}</div>
                    </div>
                    <div class="choice-effect">
                      <div class="choice-effect-label">–°—Ç—Ä–∞—Å—Ç—å</div>
                      <div class="choice-effect-value">${choice.required_passion_level}</div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-top:24px;">
        <button class="btn-editor btn-preview" style="flex:1;" onclick="previewScene(${scene.id})">
          <svg style="width:18px;height:18px;margin-right:6px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4A10,10 0 0,0 2,14C2,16.67 3.11,19.11 5,21C5.5,21.5 6,22 7,22H17C18,22 18.5,21.5 19,21C20.89,19.11 22,16.67 22,14A10,10 0 0,0 12,4Z" />
          </svg>
          –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ü–µ–Ω—ã
        </button>
        <button class="btn-editor btn-save" style="flex:1;" onclick="openSceneModal(${scene.id})">
          <svg style="width:18px;height:18px;margin-right:6px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />
          </svg>
          –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—É
        </button>
        <button class="btn-editor btn-save" style="flex:1;" onclick="removeScene(${scene.id})">
          <svg style="width:18px;height:18px;margin-right:6px;" viewBox="0 0 24 24">
            <path fill="currentColor" d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z" />
          </svg>
          –£–¥–∞–ª–∏—Ç—å —Å—Ü–µ–Ω—É
        </button>
      </div>
    `;

    // –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    document.getElementById('sceneEditorTitle').textContent = `–°—Ü–µ–Ω–∞ ${scene.scene_number}: ${scene.character_name}`;
    document.getElementById('sceneEditorSubtitle').textContent = `ID: ${scene.id} ‚Ä¢ –ì–ª–∞–≤–∞ ${scene.chapter_id}`;
  });
}

function showEmptySceneEditor() {
  document.getElementById('sceneEditorContent').innerHTML = `
    <div class="empty-scene">
      <div class="empty-icon">‚ú®</div>
      <div class="empty-text">–†–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã</div>
      <div class="empty-subtext">–°–æ–∑–¥–∞–π—Ç–µ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–∏–∞–ª–æ–≥–∏, –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞</div>
    </div>
  `;

  document.getElementById('sceneEditorTitle').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω—É';
  document.getElementById('sceneEditorSubtitle').textContent = '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Å—Ü–µ–Ω—É –≤ —Å–ø–∏—Å–∫–µ, —á—Ç–æ–±—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
}

async function loadChoices(sceneId) {
  try {
    const response = await fetch(`/api/scenes/${sceneId}/choices`);
    const data = await response.json();

    if (data.success) {
      return data.choices || [];
    }
    return [];
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:', error);
    return [];
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–ª–∞–≤—ã
function openChapterModal(chapterId = null) {
  const modal = document.getElementById('chapterModal');
  const form = document.getElementById('chapterForm');
  const title = document.getElementById('chapterModalTitle');

  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
  form.reset();
  document.getElementById('chapterId').value = '';

  if (chapterId) {
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –≥–ª–∞–≤—ã
    const chapter = chapters.find(c => c.id === chapterId);
    if (chapter) {
      title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–ª–∞–≤—É';
      document.getElementById('chapterId').value = chapter.id;
      document.getElementById('chapterNumber').value = chapter.chapter_number;
      document.getElementById('chapterTitle').value = chapter.title || '';
      document.getElementById('chapterDescription').value = chapter.description || '';
      document.getElementById('chapterBackground').value = chapter.background_image || '';
    }
  } else {
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –≥–ª–∞–≤—ã
    title.textContent = '–ù–æ–≤–∞—è –≥–ª–∞–≤–∞';
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Å–ª–µ–¥—É—é—â–µ–π –≥–ª–∞–≤—ã
    const nextNumber = chapters.length > 0 ? Math.max(...chapters.map(c => c.chapter_number)) + 1 : 1;
    document.getElementById('chapterNumber').value = nextNumber;
  }

  modal.classList.add('active');
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–ª–∞–≤—É
async function saveChapter(e) {
  e.preventDefault();

  const chapterId = document.getElementById('chapterId').value;
  const chapterNumber = parseInt(document.getElementById('chapterNumber').value);
  const title = document.getElementById('chapterTitle').value.trim();
  const description = document.getElementById('chapterDescription').value.trim();
  const background = document.getElementById('chapterBackground').value.trim();

  try {
    let response;
    if (chapterId) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      response = await fetch(`/api/chapters/${chapterId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          title: title || null,
          description: description || null,
          background_image: background || null
        })
      });
    } else {
      // –°–æ–∑–¥–∞–Ω–∏–µ
      response = await fetch('/api/chapters', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          story_id: currentStoryId,
          chapter_number: chapterNumber,
          title: title || null,
          description: description || null,
          background_image: background || null
        })
      });
    }

    const data = await response.json();

    if (response.ok && data.success) {
      closeModal('chapterModal');
      loadChapters();
      showNotification('–ì–ª–∞–≤–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥–ª–∞–≤—ã');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
}

function removeScene(sceneId) {
  response = await fetch(`/api/scenes/${sceneId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    });

  const data = await response.json()

  if (data.success) {
    alert('–°—Ü–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!')

    loadScenes(currentChapterId);
  } else {
    alert(data.msg)
  }
}

function openSceneModal(sceneId = null) {
  const modal = document.getElementById('sceneModal');
  const form = document.getElementById('sceneForm');
  const title = document.getElementById('sceneModalTitle');

  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
  form.reset();
  document.getElementById('sceneId').value = '';
  document.getElementById('sceneChapterId').value = currentChapterId || '';

  if (sceneId) {
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ü–µ–Ω—ã
    const scene = scenes.find(s => s.id === sceneId);
    if (scene) {
      title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω—É';
      document.getElementById('sceneId').value = scene.id;
      document.getElementById('sceneNumber').value = scene.scene_number;
      document.getElementById('characterName').value = scene.character_name;
      document.getElementById('dialogueText').value = scene.dialogue_text;
      document.getElementById('characterImage').value = scene.character_image || '';
      document.getElementById('sceneBackground').value = scene.background_image || '';
      document.getElementById('musicTrack').value = scene.music_track || '';
      document.getElementById('positionX').value = scene.position_x || 0;
      document.getElementById('positionY').value = scene.position_y || 0;
      document.getElementById('scale').value = scene.scale || 1.0;
    }
  } else {
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Å—Ü–µ–Ω—ã
    title.textContent = '–ù–æ–≤–∞—è —Å—Ü–µ–Ω–∞';
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Å–ª–µ–¥—É—é—â–µ–π —Å—Ü–µ–Ω—ã
    const nextNumber = scenes.length > 0 ? Math.max(...scenes.map(s => s.scene_number)) + 1 : 1;
    document.getElementById('sceneNumber').value = nextNumber;
    document.getElementById('characterName').value = '–í–∏–∫—Å–∞—Ä–∏—è';
  }

  modal.classList.add('active');
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ü–µ–Ω—É
async function saveScene(e) {
  e.preventDefault();

  const sceneId = document.getElementById('sceneId').value;
  const chapterId = document.getElementById('sceneChapterId').value;
  const sceneNumber = parseInt(document.getElementById('sceneNumber').value);
  const characterName = document.getElementById('characterName').value.trim();
  const dialogueText = document.getElementById('dialogueText').value.trim();
  const characterImage = document.getElementById('characterImage').value.trim();
  const background = document.getElementById('sceneBackground').value.trim();
  const music = document.getElementById('musicTrack').value.trim();
  const positionX = parseInt(document.getElementById('positionX').value) || 0;
  const positionY = parseInt(document.getElementById('positionY').value) || 0;
  const scale = parseFloat(document.getElementById('scale').value) || 1.0;

  if (!characterName || !dialogueText) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ —Ç–µ–∫—Å—Ç –¥–∏–∞–ª–æ–≥–∞');
    return;
  }

  try {
    let response;
    if (sceneId) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      response = await fetch(`/api/scenes/${sceneId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          character_name: characterName,
          dialogue_text: dialogueText,
          character_image: characterImage || null,
          background_image: background || null,
          music_track: music || null,
          position_x: positionX,
          position_y: positionY,
          scale: scale
        })
      });
    } else {
      // –°–æ–∑–¥–∞–Ω–∏–µ
      response = await fetch('/api/scenes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          chapter_id: chapterId,
          scene_number: sceneNumber,
          character_name: characterName,
          dialogue_text: dialogueText,
          character_image: characterImage || null,
          background_image: background || null,
          music_track: music || null,
          position_x: positionX,
          position_y: positionY,
          scale: scale
        })
      });
    }

    const data = await response.json();

    if (response.ok && data.success) {
      closeModal('sceneModal');
      if (currentChapterId) {
        loadScenes(currentChapterId);
      }
      showNotification('–°—Ü–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω—ã');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
}

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
function openChoiceModal(sceneId = null, choiceId = null) {
  const modal = document.getElementById('choiceModal');
  const form = document.getElementById('choiceForm');
  const title = document.getElementById('choiceModalTitle');

  // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
  form.reset();
  document.getElementById('choiceId').value = '';
  document.getElementById('choiceSceneId').value = sceneId || '';

  if (choiceId) {
    title.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç';
    document.getElementById('choiceId').value = choiceId;
  } else {
    title.textContent = '–ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞';
    document.getElementById('choiceNumber').value = document.querySelectorAll('.choice-item').length + 1 || 1;
  }

  modal.classList.add('active');
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞
async function saveChoice(e) {
  e.preventDefault();

  const choiceId = document.getElementById('choiceId').value;
  const sceneId = document.getElementById('choiceSceneId').value;
  const choiceNumber = parseInt(document.getElementById('choiceNumber').value);
  const choiceText = document.getElementById('choiceText').value.trim();
  const nextSceneId = document.getElementById('nextSceneId').value.trim() || null;
  const nextChapterId = document.getElementById('nextChapterId').value.trim() || null;
  //const effectType = document.getElementById('effectType').value || null;
  const friendship = parseInt(document.getElementById('friendshipChange').value) || 0;
  const teasing = parseInt(document.getElementById('teasingChange').value) || 0;
  const passion = parseInt(document.getElementById('passionChange').value) || 0;
  const premium = document.getElementById('choicePremium').checked;
  const diamonds = parseInt(document.getElementById('diamondsCost').value) || 0;
  const requiredPassionLevel = parseInt(document.getElementById('requiredPassionLevel').value) || 0;
  const requiredTeasingLevel = parseInt(document.getElementById('requiredTeasingLevel').value) || 0;
  const requiredFriendshipLevel = parseInt(document.getElementById('requiredFriendshipLevel').value) || 0;


  if (!choiceText) {
    alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤—ã–±–æ—Ä–∞');
    return;
  }

  try {
    let response;
    if (choiceId) {
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ
      response = await fetch(`/api/choices/${choiceId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          choice_text: choiceText,
          next_scene_id: nextSceneId ? parseInt(nextSceneId) : null,
          next_chapter_id: nextChapterId ? parseInt(nextChapterId) : null,
          effect_type: null,
          friendship_change: friendship,
          teasing_change: teasing,
          passion_change: passion,
          premium: premium,
          diamonds_cost: diamonds,
          required_passion_level: requiredPassionLevel,
          required_friendship_level: requiredFriendshipLevel,
          required_teasing_level: requiredTeasingLevel
        })
      });
    } else {
      response = await fetch('/api/choices', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          scene_id: parseInt(sceneId),
          choice_number: choiceNumber,
          choice_text: choiceText,
          next_scene_id: nextSceneId ? parseInt(nextSceneId) : null,
          next_chapter_id: nextChapterId ? parseInt(nextChapterId) : null,
          effect_type: null,
          friendship_change: friendship,
          teasing_change: teasing,
          passion_change: passion,
          premium: premium,
          diamonds_cost: diamonds,
          required_passion_level: requiredPassionLevel,
          required_friendship_level: requiredFriendshipLevel,
          required_teasing_level: requiredTeasingLevel
        })
      });
    }

    const data = await response.json();

    if (response.ok && data.success) {
      closeModal('choiceModal');
      if (currentSceneId) {
        selectScene(currentSceneId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã
      }
      showNotification('–í–∞—Ä–∏–∞–Ω—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
}

async function editChoice(choiceId) {
  try {
    const response = await fetch(`/api/choices/${choiceId}`);
    const data = await response.json();

    if (data.success && data.choice) {
      openChoiceModal(null, choiceId);

      setTimeout(() => {
        document.getElementById('choiceId').value = data.choice.id;
        document.getElementById('choiceNumber').value = data.choice.number;
        document.getElementById('choiceText').value = data.choice.text;
        document.getElementById('nextSceneId').value = data.choice.next_scene_id || '';
        document.getElementById('nextChapterId').value = data.choice.next_chapter_id || '';
        //document.getElementById('effectType').value = data.choice.effect_type || '';
        document.getElementById('teasingChange').value = data.choice.teasing_change || 0;
        document.getElementById('friendshipChange').value = data.choice.friendship_change || 0;
        document.getElementById('passionChange').value = data.choice.passion_change || 0;
        document.getElementById('choicePremium').checked = data.choice.premium ? true : false;
        document.getElementById('diamondsCost').value = data.choice.diamonds_cost || 0;
        document.getElementById('requiredPassionLevel').value = data.choice.required_passion_level || 0;
        document.getElementById('requiredFriendshipLevel').value = data.choice.required_friendship_level || 0;
        document.getElementById('requiredTeasingLevel').value = data.choice.required_teasing_level || 0;
      }, 100);
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞: ' + error.message);
  }
}

// –£–¥–∞–ª–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞
async function deleteChoice(choiceId) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –≤—ã–±–æ—Ä–∞?')) {
    return;
  }

  try {
    const response = await fetch(`/api/choices/${choiceId}`, {
      method: 'DELETE'
    });

    const data = await response.json();

    if (response.ok && data.success) {
      if (currentSceneId) {
        selectScene(currentSceneId); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å—Ü–µ–Ω—ã
      }
      showNotification('–í–∞—Ä–∏–∞–Ω—Ç —É–¥–∞–ª–µ–Ω', 'success');
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('active');
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é (–ø—É–±–ª–∏–∫–∞—Ü–∏—è)
async function saveStory() {
  if (!confirm('–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é? –ü–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–≥—Ä–æ–∫–∏ —Å–º–æ–≥—É—Ç –µ—ë –ø—Ä–æ—Ö–æ–¥–∏—Ç—å.')) {
    return;
  }

  try {
    const response = await fetch(`/api/stories/${currentStoryId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        is_published: true
      })
    });

    const data = await response.json();

    if (response.ok && data.success) {
      showNotification('–ò—Å—Ç–æ—Ä–∏—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!', 'success');
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç –∏—Å—Ç–æ—Ä–∏–∏
async function exportStory() {
  try {
    const response = await fetch(`/api/stories/${currentStoryId}/export`);
    const data = await response.json();

    if (data.success) {
      // –°–∫–∞—á–∞—Ç—å JSON —Ñ–∞–π–ª
      const blob = new Blob([JSON.stringify(data.story, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `story_${currentStoryId}_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);

      showNotification('–ò—Å—Ç–æ—Ä–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
    } else {
      alert(data.error || '–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏');
  }
}

// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
function previewStory() {
  alert('–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞');
}

function previewScene(sceneId) {
  alert(`–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ü–µ–Ω—ã ${sceneId} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏`);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
function uploadImage(fieldId) {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('image', file);

    fetch('/api/upload/image', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(fieldId).value = data.url;
        showNotification('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
      } else {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + data.error);
      }
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
    });
  };
  input.click();
}

// –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
function showNotification(message, type = 'info') {
  // –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  const notification = document.createElement('div');
  notification.className = `notification notification-${type}`;
  notification.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: ${type === 'success' ? 'rgba(16, 185, 129, 0.9)' : 'rgba(99, 102, 241, 0.9)'};
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    z-index: 1000;
    transform: translateX(300px);
    opacity: 0;
    transition: all 0.4s ease;
  `;
  notification.textContent = message;

  document.body.appendChild(notification);

  // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
    notification.style.opacity = '1';
  }, 10);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
  setTimeout(() => {
    notification.style.transform = 'translateX(300px)';
    notification.style.opacity = '0';
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 3000);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
document.addEventListener('click', function(e) {
  document.querySelectorAll('.modal').forEach(modal => {
    if (modal.classList.contains('active') && e.target === modal) {
      modal.classList.remove('active');
    }
  });
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏—à
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal').forEach(modal => {
      modal.classList.remove('active');
    });
  }
});
</script>
{% endblock %}