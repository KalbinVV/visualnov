{% extends "base.html" %}

{% block title %}Создать историю — Админка{% endblock %}

{% block content %}
<div class="admin-container">
  <div class="top-bar">
    <div class="top-left">
      <button class="icon-btn back-btn" onclick="window.location.href='/admin/stories'">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" fill="none"/>
        </svg>
      </button>
      <h1 class="page-title">Создать новую историю</h1>
    </div>
  </div>

  <div class="main-content">
    <div class="create-form-container">
      <form id="createStoryForm" class="create-form">

        <!-- Основная информация -->
        <section class="form-section">
          <h3>Основная информация</h3>

          <div class="form-group">
            <label for="storyKey">Ключ истории <span class="required">*</span></label>
            <input type="text" id="storyKey" name="story_key" required
                   pattern="[a-zA-Z0-9_]+" title="Только латинские буквы, цифры и _"
                   placeholder="first_kiss, summer_nights_2025">
            <small>Уникальный идентификатор (используется в URL)</small>
          </div>

          <div class="form-group">
            <label for="title">Название <span class="required">*</span></label>
            <input type="text" id="title" name="title" required
                   placeholder="Первая искра • Запретное желание">
          </div>

          <div class="form-group">
            <label for="description">Описание сюжета</label>
            <textarea id="description" name="description" rows="4"
                      placeholder="Коротко о чём история, кто главные герои, настроение..."></textarea>
          </div>
        </section>

        <!-- Обложка и фон -->
        <section class="form-section media-section">
          <h3>Визуальное оформление</h3>

          <div class="media-grid">
            <!-- Обложка -->
            <div class="media-upload">
              <label>Обложка истории</label>
              <div class="dropzone" id="coverDropzone">
                <input type="file" id="coverFile" accept="image/*" hidden>
                <div class="dropzone-content">
                  <div class="preview" id="coverPreview"></div>
                  <p>Перетащите обложку сюда или</p>
                  <button type="button" class="btn-select">Выбрать файл</button>
                </div>
              </div>
              <input type="hidden" id="coverImage" name="cover_image">
              <small>Рекомендуемый размер: 400×600</small>
            </div>

            <!-- Фон -->
            <div class="media-upload">
              <label>Фоновое изображение</label>
              <div class="dropzone" id="bgDropzone">
                <input type="file" id="bgFile" accept="image/*" hidden>
                <div class="dropzone-content">
                  <div class="preview" id="bgPreview"></div>
                  <p>Перетащите фон сюда или</p>
                  <button type="button" class="btn-select">Выбрать файл</button>
                </div>
              </div>
              <input type="hidden" id="backgroundImage" name="background_image">
              <small>Рекомендуемый размер: 1920×1080 или шире</small>
            </div>
          </div>
        </section>

        <!-- Монетизация и статус -->
        <section class="form-section settings-section">
          <h3>Настройки доступа</h3>

          <div class="form-row">
            <div class="form-group toggle-group">
              <label>Премиум-история</label>
              <label class="switch">
                <input type="checkbox" id="premium" name="premium">
                <span class="slider round"></span>
              </label>
            </div>

            <div class="form-group">
              <label for="diamondsCost">Стоимость в алмазах</label>
              <input type="number" id="diamondsCost" name="diamonds_cost"
                     min="0" step="10" value="0">
            </div>
          </div>

          <div class="form-group toggle-group">
            <label>Сразу опубликовать</label>
            <label class="switch">
              <input type="checkbox" id="published" name="is_published">
              <span class="slider round"></span>
            </label>
            <small>Если не включено — останется в черновиках</small>
          </div>
        </section>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="history.back()">
            Отмена
          </button>
          <button type="submit" class="btn btn-primary" id="submitBtn">
            Создать историю
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  :root {
    --accent: #6366f1;
    --accent-dark: #4f46e5;
    --danger: #ef4444;
    --success: #10b981;
  }

  .required { color: var(--danger); }

  .media-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  .media-upload {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .dropzone {
    height: 220px;
    border: 2px dashed var(--input-border);
    border-radius: 16px;
    background: rgba(30,30,50,0.4);
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .dropzone:hover,
  .dropzone.dragover {
    border-color: var(--accent);
    background: rgba(99,102,241,0.08);
  }

  .dropzone-content {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--text-secondary);
    padding: 20px;
  }

  .preview {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 12px;
    background: #111;
    margin-bottom: 12px;
    display: none;
  }

  .preview.has-image {
    display: block;
  }

  .btn-select {
    margin-top: 8px;
    padding: 8px 16px;
    background: rgba(99,102,241,0.15);
    border: 1px solid var(--accent);
    border-radius: 8px;
    color: var(--accent);
    cursor: pointer;
  }

  .toggle-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
  }

  @media (max-width: 900px) {
    .media-grid,
    .form-row {
      grid-template-columns: 1fr;
    }
  }

  .form-actions {
    margin-top: 40px;
    display: flex;
    gap: 16px;
    justify-content: flex-end;
  }

  .btn {
    padding: 12px 28px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-primary {
    background: var(--accent);
    color: white;
    border: none;
  }

  .btn-primary:hover { background: var(--accent-dark); }
  .btn-secondary {
    background: transparent;
    border: 1px solid var(--text-secondary);
    color: var(--text-primary);
  }
</style>

<script>
// --------------------------------------------------
// Загрузка изображений
// --------------------------------------------------
async function uploadImage(file) {
  if (!file) return null;

  const formData = new FormData();
  formData.append('image', file);

  try {
    const res = await fetch('/api/upload/image', {
      method: 'POST',
      body: formData
    });

    const data = await res.json();
    if (data.success && data.url) {
      return data.url;
    } else {
      alert('Не удалось загрузить изображение: ' + (data.error || 'неизвестная ошибка'));
      return null;
    }
  } catch (err) {
    console.error(err);
    alert('Ошибка при загрузке изображения');
    return null;
  }
}

function setupDropzone(dropzoneId, fileInputId, previewId, hiddenInputId) {
  const dropzone = document.getElementById(dropzoneId);
  const fileInput = document.getElementById(fileInputId);
  const preview = document.getElementById(previewId);
  const hidden = document.getElementById(hiddenInputId);

  // Клик по зоне → открываем выбор файла
  dropzone.addEventListener('click', () => fileInput.click());

  // Выбор файла через кнопку / input
  fileInput.addEventListener('change', async e => {
    const file = e.target.files[0];
    if (!file) return;

    const url = await uploadImage(file);
    if (url) {
      preview.src = url;
      preview.classList.add('has-image');
      hidden.value = url;
    }
  });

  // Drag & Drop
  ['dragover', 'dragenter'].forEach(event => {
    dropzone.addEventListener(event, e => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
  });

  ['dragleave', 'drop'].forEach(event => {
    dropzone.addEventListener(event, e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
    });
  });

  dropzone.addEventListener('drop', async e => {
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      const url = await uploadImage(file);
      if (url) {
        preview.src = url;
        preview.classList.add('has-image');
        hidden.value = url;
      }
    }
  });
}

// Инициализация
document.addEventListener('DOMContentLoaded', () => {
  setupDropzone('coverDropzone', 'coverFile', 'coverPreview', 'coverImage');
  setupDropzone('bgDropzone',   'bgFile',   'bgPreview',   'backgroundImage');

  // Отправка формы
  const form = document.getElementById('createStoryForm');
  const submitBtn = document.getElementById('submitBtn');

  form.addEventListener('submit', async e => {
    e.preventDefault();

    const data = {
      story_key:      document.getElementById('storyKey').value.trim(),
      title:          document.getElementById('title').value.trim(),
      description:    document.getElementById('description').value.trim() || null,
      cover_image:    document.getElementById('coverImage').value.trim() || null,
      background_image: document.getElementById('backgroundImage').value.trim() || null,
      premium:        document.getElementById('premium').checked,
      diamonds_cost:  parseInt(document.getElementById('diamondsCost').value) || 0,
      is_published:   document.getElementById('published').checked
    };

    if (!data.story_key || !data.title) {
      alert('Заполните обязательные поля: ключ и название');
      return;
    }

    if (!/^[a-zA-Z0-9_]+$/.test(data.story_key)) {
      alert('Ключ может содержать только латинские буквы, цифры и нижнее подчёркивание');
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Создаём...';

    try {
      const res = await fetch('/api/stories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const json = await res.json();

      if (res.ok && json.success) {
        window.location.href = `/admin/stories/editor/${json.story.id}`;
      } else {
        alert(json.error || 'Не удалось создать историю');
      }
    } catch (err) {
      console.error(err);
      alert('Ошибка соединения с сервером');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Создать историю';
    }
  });
});
</script>
{% endblock %}